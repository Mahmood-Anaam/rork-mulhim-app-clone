# Execution Log (STEPS.md)

All changes follow [Conventional Commits](https://www.conventionalcommits.org/) and are grouped by logical concern.

---

## Step 1 — Analysis & Cleanup

### Files Touched

| Action | File | Justification |
|---|---|---|
| Analysed | `package.json` | Identified Rork-hijacked scripts and vendor-locked `@rork-ai/toolkit-sdk` |
| Analysed | `metro.config.js` | Found `withRorkMetro` wrapper preventing standard Expo usage |
| Analysed | `app/_layout.tsx` | Found `trpc.Provider` requiring the defunct Rork backend URL |
| Analysed | `lib/trpc.ts` | Entire file is Rork-specific — reads `EXPO_PUBLIC_RORK_API_BASE_URL` |
| Analysed | `app/(tabs)/coach.tsx` | Uses `useRorkAgent` and `createRorkTool` from the vendor SDK |
| Analysed | `app/(tabs)/nutrition.tsx` | Uses `generateObject` from the vendor SDK |
| Analysed | `lib/supabase.ts` | Credentials hard-coded instead of reading from env vars |

**Architectural Justification:** Complete discovery before touching code prevents regressions and ensures all Rork surface area is identified.

---

## Step 2 — Core Decoupling

### 2.1 Fix `package.json`

**Commit:** `chore: replace rork scripts with standard expo commands; remove vendor-locked deps`

| Action | Detail |
|---|---|
| Replaced `scripts.start` | `bunx rork start ...` → `expo start` |
| Added `scripts.android/ios/web` | Standard Expo targets |
| Removed `@rork-ai/toolkit-sdk` | Vendor-locked, replaced by direct OpenAI REST calls |
| Removed `@hono/trpc-server`, `hono`, `@trpc/*`, `superjson` | Only served the removed Rork backend |
| Removed `@stardazed/streams-text-encoding`, `@ungap/structured-clone`, `react-native-worklets` | Rork SDK polyfills, no longer needed |

### 2.2 Fix `metro.config.js`

**Commit:** `chore: remove withRorkMetro wrapper from metro config`

Removed the `withRorkMetro` wrapper so Metro uses the plain Expo default config. This allows `expo start` to work without `@rork-ai/toolkit-sdk` installed.

### 2.3 Remove dead Rork infrastructure

**Commit:** `chore: delete lib/trpc.ts and backend/ directory`

| Deleted | Justification |
|---|---|
| `lib/trpc.ts` | Only connected to the Rork-hosted tRPC server |
| `backend/hono.ts` | Server-side Hono app — not applicable to a mobile client bundle |
| `backend/trpc/` | tRPC router generated by Rork — no longer needed |

---

## Step 3 — Environment & Configuration

### 3.1 Create `src/utils/config.ts`

**Commit:** `feat: add central config module reading EXPO_PUBLIC env vars`

Single export `config` object. All other files import from here — no scattered `process.env` reads.

### 3.2 Fix `lib/supabase.ts`

**Commit:** `refactor: read supabase credentials from config instead of hard-coding`

Eliminates hard-coded credentials from source control. Reads `config.supabaseUrl` and `config.supabaseAnonKey`.

### 3.3 Create `.env.example`

**Commit:** `chore: add .env.example with required variable names`

Template committed to source control; actual `.env` remains git-ignored.

---

## Step 4 — OpenAI Integration

### 4.1 Create `src/services/openai.ts`

**Commit:** `feat: add openai service — generateObject and chatWithTools`

| Export | Purpose |
|---|---|
| `zodToJsonSchema` | Converts Zod schemas to OpenAI-compatible JSON Schema |
| `generateObject<T>` | Calls Chat Completions with `json_object` mode, validates with Zod |
| `chatWithTools` | Single-shot chat call with OpenAI function calling |

### 4.2 Create `src/hooks/useOpenAICoach.ts`

**Commit:** `feat: add useOpenAICoach hook — drop-in replacement for useRorkAgent`

Maintains identical message-part shape (`{type, text}` / `{type, toolName, state, output}`) so the existing Coach UI works without modifications. Uses a `useRef` for tools to always call the latest execute closures.

---

## Step 5 — Screen Migrations

### 5.1 `app/(tabs)/coach.tsx`

**Commit:** `refactor: replace useRorkAgent/createRorkTool with useOpenAICoach`

| Change | Detail |
|---|---|
| Removed import | `import { useRorkAgent, createRorkTool } from "@rork-ai/toolkit-sdk"` |
| Added import | `import { useOpenAICoach } from "@/src/hooks/useOpenAICoach"` |
| Replaced hook call | `useRorkAgent({tools: {x: createRorkTool({...})}})` → `useOpenAICoach({tools: {x: {...}}, systemPrompt})` |
| Removed `createRorkTool` wrappers | Tool definitions now plain objects |
| Added `systemPrompt` | Bilingual system prompt sets AI persona |

### 5.2 `app/(tabs)/nutrition.tsx`

**Commit:** `refactor: replace rork generateObject with openai service`

| Change | Detail |
|---|---|
| Removed import | `import { generateObject } from "@rork-ai/toolkit-sdk"` |
| Added import | `import { generateObject } from "@/src/services/openai"` |

The function signature is identical — no other changes needed.

### 5.3 `app/_layout.tsx`

**Commit:** `refactor: remove trpc.Provider from root layout`

Removed `trpc.Provider` wrapper (required the defunct Rork backend URL) and the related import. `QueryClientProvider` is retained for `@tanstack/react-query`.

---

## Step 6 — Documentation

**Commit:** `docs: add bilingual RUN_GUIDE, ARCHITECTURE, PLANNING, and STEPS`

| File | Language |
|---|---|
| `docs/PLANNING.md` | English — current vs target architecture |
| `docs/en/RUN_GUIDE.md` | English |
| `docs/ar/RUN_GUIDE.md` | Arabic |
| `docs/en/ARCHITECTURE.md` | English — data lifecycle & folder structure |
| `docs/ar/ARCHITECTURE.md` | Arabic |
| `docs/STEPS.md` | English — this file |
