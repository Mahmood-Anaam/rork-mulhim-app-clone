# تطبيق مُلهم - التوثيق

## جدول المحتويات

- [نظرة عامة](#نظرة-عامة)
- [البنية المعمارية](#البنية-المعمارية)
- [البدء](#البدء)
- [شاشات التطبيق وتدفق المستخدم](#شاشات-التطبيق-وتدفق-المستخدم)
- [تدفق البيانات والتكامل مع Supabase](#تدفق-البيانات-والتكامل-مع-supabase)
- [المصادقة](#المصادقة)
- [إدارة الحالة](#إدارة-الحالة)
- [مخطط قاعدة البيانات](#مخطط-قاعدة-البيانات)
- [إعداد البيئة](#إعداد-البيئة)
- [استكشاف الأخطاء](#استكشاف-الأخطاء)

---

## نظرة عامة

مُلهم هو تطبيق تدريب لياقة بدنية ثنائي اللغة (عربي/إنجليزي) مبني باستخدام React Native و Expo. يقدم التطبيق:

- **خطط تمارين مولدة بالذكاء الاصطناعي** مخصصة حسب ملف اللياقة البدنية للمستخدم
- **تخطيط غذائي** يركز على المأكولات السعودية والشرق أوسطية
- **تتبع التقدم** مع سجلات الوزن وإكمال التمارين
- **مدرب ذكاء اصطناعي** لنصائح لياقة مخصصة
- **دعم كامل للعربية** مع واجهة من اليمين لليسار (RTL)
- **بنية أولوية عدم الاتصال** مع تخزين مؤقت محلي عبر AsyncStorage

---

## البنية المعمارية

### مكدس التقنيات

| الطبقة | التقنية |
|---|---|
| **إطار واجهة المستخدم** | React Native 0.81 + Expo 54 |
| **التنقل** | Expo Router (قائم على الملفات) |
| **اللغة** | TypeScript (وضع صارم) |
| **الخلفية** | Supabase (PostgreSQL + المصادقة + RLS) |
| **حالة الخادم** | React Query + tRPC |
| **الحالة المحلية** | React Context + AsyncStorage |
| **الأيقونات** | Lucide React Native |
| **البناء** | Metro Bundler + Babel |

### هيكل المجلدات

```
mulhim-app/
├── app/                    # الشاشات والتنقل (Expo Router)
│   ├── (tabs)/             # شاشات التبويب الرئيسية
│   ├── auth/               # شاشات المصادقة (تسجيل الدخول، التسجيل)
│   ├── _layout.tsx         # التخطيط الجذري مع المزودين
│   └── index.tsx           # نقطة الدخول / منطق التوجيه
├── src/                    # الكود المصدري للتطبيق
│   ├── config/             # الإعدادات (متغيرات البيئة، عميل Supabase)
│   ├── services/           # طبقة الوصول للبيانات (عمليات Supabase CRUD)
│   ├── providers/          # مزودات سياق React (المصادقة، اللياقة، اللغة)
│   ├── types/              # تعريفات أنواع TypeScript
│   ├── constants/          # الألوان، الترجمات
│   ├── data/               # قواعد بيانات التمارين والوجبات الثابتة
│   ├── hooks/              # خطافات React مخصصة
│   └── api/                # واجهة برمجة الخلفية (Hono + tRPC)
├── assets/                 # الصور والأيقونات
├── docs/                   # التوثيق
└── supabase-migration.sql  # مخطط قاعدة البيانات وسياسات RLS
```

### أنماط التصميم

1. **أولوية عدم الاتصال**: جميع البيانات مخزنة مؤقتاً في AsyncStorage ومتزامنة مع Supabase عند الاتصال
2. **نمط المستودع**: `remoteFitnessRepo.ts` يجرد جميع عمليات Supabase
3. **نمط المزود**: مزودات سياق React تدير المصادقة وبيانات اللياقة وحالة اللغة
4. **التصدير الجماعي**: كل وحدة لها `index.ts` لاستيراد نظيف
5. **إعداد البيئة**: جميع الأسرار تدار عبر ملفات `.env`

---

## البدء

### المتطلبات الأساسية

- **Node.js** الإصدار 18 أو أعلى
- مدير حزم **npm** أو **Bun**
- تطبيق **Expo Go** على جهازك المحمول (للاختبار)
- مشروع **Supabase** (لخدمات الخلفية)

### التثبيت

```bash
# 1. نسخ المستودع
git clone https://github.com/your-username/rork-mulhim-app-clone.git
cd rork-mulhim-app-clone

# 2. تثبيت التبعيات
npm install --legacy-peer-deps

# 3. إعداد متغيرات البيئة
cp .env.example .env
# قم بتحرير .env بالقيم الفعلية

# 4. إعداد قاعدة البيانات
# قم بتشغيل SQL في supabase-migration.sql في محرر SQL الخاص بـ Supabase

# 5. بدء خادم التطوير
npm start
```

### متغيرات البيئة

| المتغير | الوصف | مطلوب |
|---|---|---|
| `EXPO_PUBLIC_SUPABASE_URL` | رابط مشروع Supabase | نعم |
| `EXPO_PUBLIC_SUPABASE_ANON_KEY` | مفتاح Supabase العام | نعم |
| `EXPO_PUBLIC_RORK_DB_ENDPOINT` | نقطة نهاية Rork DB API | نعم |
| `EXPO_PUBLIC_RORK_DB_NAMESPACE` | معرف مساحة اسم Rork DB | نعم |
| `EXPO_PUBLIC_RORK_DB_TOKEN` | رمز وصول Rork DB | نعم |

### التشغيل على الجهاز

1. ثبت **Expo Go** من App Store (iOS) أو Google Play (Android)
2. شغل `npm start` في مجلد المشروع
3. امسح رمز QR المعروض في الطرفية
4. سيتم تحميل التطبيق على جهازك

### التشغيل على الويب

```bash
npm run start-web
```

---

## شاشات التطبيق وتدفق المستخدم

### 1. شاشة الترحيب (`welcome.tsx`)
- **الغرض**: اختيار اللغة (عربي / إنجليزي)
- **الإجراءات**: يختار المستخدم لغته المفضلة
- **التنقل**: ينتقل إلى شاشة الحساب أو الإعداد

### 2. اختيار الحساب (`account-prompt.tsx`)
- **الغرض**: حث المستخدم على إنشاء حساب أو المتابعة كضيف
- **الإجراءات**: التسجيل، تسجيل الدخول، أو المتابعة كضيف
- **التنقل**: شاشات المصادقة أو الإعداد

### 3. المصادقة (`auth/login.tsx`، `auth/signup.tsx`)
- **الغرض**: مصادقة المستخدم عبر Supabase
- **تسجيل الدخول**: مصادقة بالبريد الإلكتروني وكلمة المرور
- **التسجيل**: إنشاء حساب جديد مع التحقق من البريد الإلكتروني
- **الميزات**: استعادة كلمة المرور، معالجة الأخطاء

### 4. الإعداد الأولي (`onboarding.tsx`)
- **الغرض**: جمع بيانات ملف اللياقة البدنية
- **البيانات المجمعة**:
  - العمر، الوزن، الطول، الجنس
  - هدف اللياقة (خسارة دهون، بناء عضلات، لياقة عامة)
  - مستوى اللياقة (مبتدئ، متوسط، متقدم)
  - مكان التدريب (نادي، منزل، معدات بسيطة)
  - مستوى النشاط
  - أيام التدريب المتاحة
  - مدة الجلسة المفضلة
  - الإصابات الحالية
- **التنقل**: يحفظ الملف وينتقل لتبويب الخطة

### 5. تبويب الخطة (`(tabs)/plan.tsx`)
- **الغرض**: عرض وإدارة خطط التمارين الأسبوعية
- **الميزات**:
  - خطة تمارين مولدة بالذكاء الاصطناعي بناءً على ملف المستخدم
  - عرض جلسات التمرين حسب اليوم
  - تتبع إكمال الجلسات
  - عرض تفاصيل التمارين (مجموعات، تكرارات، راحة، فيديو)
  - تحديد التمارين كمكتملة
- **تدفق البيانات**: يقرأ من `FitnessProvider` → يتزامن مع Supabase

### 6. تبويب التغذية (`(tabs)/nutrition.tsx`)
- **الغرض**: تخطيط التغذية وإدارة الوجبات
- **الميزات**:
  - استبيان تقييم التغذية
  - خطط وجبات يومية/أسبوعية مولدة بالذكاء الاصطناعي
  - اقتراحات وجبات سعودية/شرق أوسطية
  - تتبع الماكرو (سعرات، بروتين، كربوهيدرات، دهون)
  - إنشاء قائمة مشتريات

### 7. تبويب المدرب (`(tabs)/coach.tsx`)
- **الغرض**: تدريب لياقة بالذكاء الاصطناعي
- **الميزات**:
  - نصائح لياقة مخصصة
  - توصيات تمارين
  - إرشادات تغذية
  - تحليل التقدم

### 8. تبويب الملف الشخصي (`(tabs)/profile.tsx`)
- **الغرض**: إدارة ملف المستخدم
- **الميزات**:
  - عرض/تعديل ملف اللياقة
  - تتبع التقدم (رسم بياني للوزن)
  - إضافة إدخالات الوزن
  - عرض سجل التمارين
  - إدارة التمارين والوجبات المفضلة
  - تحليل المعلومات الحيوية
  - إدارة الحساب (تسجيل الخروج)

### 9. تفاصيل التمرين (`workout-details.tsx`)
- **الغرض**: عرض تفصيلي لجلسة التمرين
- **الميزات**: قائمة التمارين، روابط الفيديو، توصيات الأوزان

### 10. تفاصيل الوجبة (`meal-details.tsx`)
- **الغرض**: عرض تفصيلي للوجبة
- **الميزات**: المكونات، الماكرو، معلومات التحضير

### 11. المعلومات الحيوية (`bioinformatics.tsx`)
- **الغرض**: تحليل تكوين الجسم
- **الميزات**: حساب مؤشر كتلة الجسم، مقاييس الجسم

### مخطط تدفق المستخدم

```
الترحيب (اختيار اللغة)
    │
    ▼
اختيار الحساب ──────────► المصادقة (دخول/تسجيل)
    │                           │
    │ (ضيف)                     │ (مصادق)
    ▼                           ▼
الإعداد الأولي (ملف اللياقة)
    │
    ▼
التطبيق الرئيسي (التبويبات)
    ├── تبويب الخطة ──► تفاصيل التمرين
    ├── تبويب التغذية ──► تفاصيل الوجبة
    ├── تبويب المدرب
    └── تبويب الملف الشخصي ──► المعلومات الحيوية
```

---

## تدفق البيانات والتكامل مع Supabase

### نظرة عامة على البنية

```
واجهة المستخدم (مكونات React)
    │
    ▼
المزودات (AuthProvider، FitnessProvider، LanguageProvider)
    │
    ├── التخزين المحلي (AsyncStorage) ← قراءة/كتابة فورية
    │
    └── المزامنة عن بعد (Supabase عبر remoteFitnessRepo) ← مزامنة خلفية
```

### عمليات البيانات

#### إدارة الملف الشخصي
1. المستخدم يملأ نموذج الإعداد → `FitnessProvider.saveProfile()`
2. يُحفظ الملف في AsyncStorage (فوري)
3. إذا كان مصادقاً، يتزامن مع Supabase عبر `remoteFitnessRepo.upsertProfile()`
4. عند تحميل التطبيق، يُملأ من AsyncStorage أولاً، ثم يُحدث من Supabase

#### خطط التمارين
1. الذكاء الاصطناعي يولد خطة أسبوعية → `FitnessProvider.setWeekPlan()`
2. تُحفظ الخطة في AsyncStorage
3. إذا كان مصادقاً، تُحفظ في Supabase عبر `remoteFitnessRepo.saveWorkoutPlan()`
4. يُتتبع إكمال الجلسات عبر `remoteFitnessRepo.updateSessionCompletion()`

#### خطط التغذية
1. يُجمع تقييم التغذية → يُخزن محلياً
2. الذكاء الاصطناعي يولد خطة وجبات → `FitnessProvider.setNutritionPlan()`
3. تُحفظ في AsyncStorage وتتزامن مع Supabase

#### تتبع التقدم
1. المستخدم يضيف إدخال وزن → `FitnessProvider.addProgressEntry()`
2. يُحفظ في AsyncStorage
3. إذا كان مصادقاً، يتزامن عبر `remoteFitnessRepo.insertProgressEntry()`

### معالجة الأخطاء

خدمة `remoteFitnessRepo` تنفذ:
- **منطق إعادة المحاولة**: إعادة محاولة تلقائية مع تأخير أسي لأخطاء الشبكة
- **كشف أخطاء الشبكة**: تحديد فشل الجلب ولفها كـ `NETWORK_ERROR`
- **التدهور التدريجي**: التطبيق يستمر في العمل بدون اتصال باستخدام البيانات المخزنة
- **عمليات الدفعات**: مجموعات البيانات الكبيرة (التمارين) تُدرج في دفعات من 50

---

## المصادقة

### التدفق

1. **Supabase Auth** يدير مصادقة البريد الإلكتروني/كلمة المرور
2. `AuthProvider` يدير حالة الجلسة مع التجديد التلقائي
3. الجلسة محفوظة في AsyncStorage لإعادة تشغيل التطبيق
4. حالة المستخدم متاحة في كل مكان عبر خطاف `useAuth()`

### الميزات

- تسجيل بالبريد الإلكتروني/كلمة المرور مع كشف التكرار
- تسجيل دخول بالبريد الإلكتروني/كلمة المرور
- استعادة كلمة المرور عبر البريد الإلكتروني
- تجديد جلسة تلقائي
- كشف جلسة واعٍ بالمنصة (كشف URL على الويب)

---

## إدارة الحالة

### المزودات

| المزود | الغرض | الحالة الرئيسية |
|---|---|---|
| `AuthProvider` | حالة المصادقة | `user`، `session`، `isLoading` |
| `FitnessProvider` | جميع بيانات اللياقة | `profile`، `progress`، `workoutLogs`، `currentWeekPlan`، `nutritionPlan`، `favorites` |
| `LanguageProvider` | التدويل | `language`، `isRTL`، `t` (الترجمات) |

### تسلسل تحميل البيانات

1. يبدأ التطبيق → `LanguageProvider` يحمل اللغة المحفوظة من AsyncStorage
2. `AuthProvider` يتحقق من جلسة Supabase الحالية
3. تسلسل تشغيل `FitnessProvider`:
   أ. ملء جميع البيانات من AsyncStorage (سريع، بدون اتصال)
   ب. إذا كان المستخدم مصادقاً، جلب آخر البيانات من Supabase
   ج. دمج البيانات البعيدة مع التخزين المحلي
   د. تحديث واجهة المستخدم بالحالة النهائية

---

## مخطط قاعدة البيانات

تتضمن قاعدة بيانات Supabase هذه الجداول:

### `user_profiles`
- يخزن ملفات اللياقة للمستخدمين
- ملف واحد لكل مستخدم (upsert عند التعارض)
- الحقول: العمر، الوزن، الطول، الجنس، الهدف، مستوى اللياقة، إلخ.

### `workout_plans`
- يخزن خطط التمارين المولدة
- الحالة: `active` أو `archived`
- يرتبط بـ `workout_sessions`

### `workout_sessions`
- أيام تمرين فردية ضمن خطة
- يتتبع حالة الإكمال
- يرتبط بـ `exercises`

### `exercises`
- تمارين فردية ضمن جلسات
- يخزن المجموعات، التكرارات، الراحة، الأوزان، الأوصاف

### `progress_entries`
- إدخالات تتبع الوزن
- قياسات مؤرخة

### `nutrition_plans`
- خطط التغذية المولدة
- أهداف الماكرو وأنماط النظام الغذائي

### `favorite_exercises` / `favorite_meals`
- مفضلات المستخدم المحفوظة

### أمن مستوى الصف (RLS)

جميع الجداول لها سياسات RLS تضمن:
- المستخدمون يمكنهم فقط **قراءة** بياناتهم الخاصة
- المستخدمون يمكنهم فقط **إدراج** بياناتهم الخاصة
- المستخدمون يمكنهم فقط **تحديث** بياناتهم الخاصة
- المستخدمون يمكنهم فقط **حذف** بياناتهم الخاصة

---

## إعداد البيئة

### `.env.example`

```env
# إعداد Rork DB
EXPO_PUBLIC_RORK_DB_ENDPOINT="https://api.rivet.dev"
EXPO_PUBLIC_RORK_DB_NAMESPACE="your-rork-namespace"
EXPO_PUBLIC_RORK_DB_TOKEN="your-rork-db-token"

# إعداد Supabase
EXPO_PUBLIC_SUPABASE_URL="https://your-project.supabase.co"
EXPO_PUBLIC_SUPABASE_ANON_KEY="your-supabase-anon-key"
```

### كيف تعمل متغيرات البيئة

1. Expo يحمل ملفات `.env` تلقائياً
2. المتغيرات المسبوقة بـ `EXPO_PUBLIC_` متاحة في كود العميل
3. `src/config/env.ts` يركز الوصول لجميع متغيرات البيئة
4. `src/config/supabase.ts` يستخدم المتغيرات لتهيئة عميل Supabase

---

## استكشاف الأخطاء

### المشاكل الشائعة

| المشكلة | الحل |
|---|---|
| تعارض التبعيات | استخدم `npm install --legacy-peer-deps` |
| فشل اتصال Supabase | تحقق من قيم `.env` والاتصال بالشبكة |
| التطبيق يعرض تحميل للأبد | تحقق من جلسة Supabase auth؛ امسح AsyncStorage |
| RTL لا يعمل | تأكد من تعيين اللغة؛ قد تحتاج لإعادة تشغيل التطبيق |
| أخطاء TypeScript | شغل `npx tsc --noEmit` للتحقق |

### مسح التخزين المؤقت

```bash
# مسح تخزين Expo المؤقت
npx expo start --clear

# إعادة تثبيت التبعيات
rm -rf node_modules
npm install --legacy-peer-deps
```

### التصحيح

- عمليات Supabase تسجل في وحدة التحكم بالبادئة `[RemoteRepo]`
- `FitnessProvider` يسجل تسلسل التشغيل بالبادئة `[FitnessProvider]`
- أخطاء الشبكة يتم التقاطها ولفها كـ `NETWORK_ERROR`
