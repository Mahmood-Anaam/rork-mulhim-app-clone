# دليل عمليات التطبيق

## رحلة المستخدم الكاملة

### المرحلة 1: التشغيل الأول

#### اختيار اللغة
عند فتح التطبيق لأول مرة، يُعرض على المستخدم **شاشة الترحيب** حيث يمكنه الاختيار بين:
- **العربية** - تفعيل تخطيط RTL من اليمين لليسار
- **English** - تخطيط LTR قياسي من اليسار لليمين

اللغة المختارة تُحفظ في AsyncStorage وتُستخدم في جميع أنحاء التطبيق.

#### قرار الحساب
بعد اختيار اللغة، يرى المستخدم شاشة **اختيار الحساب** مع ثلاثة خيارات:
1. **إنشاء حساب** → ينتقل للتسجيل
2. **تسجيل الدخول** → ينتقل لتسجيل الدخول
3. **المتابعة كضيف** → ينتقل مباشرة للإعداد الأولي

### المرحلة 2: المصادقة (اختياري)

#### التسجيل
- المستخدم يدخل البريد الإلكتروني وكلمة المرور
- Supabase ينشئ الحساب
- قد يُطلب التحقق من البريد الإلكتروني
- عند النجاح، يُوجه المستخدم للإعداد الأولي

#### تسجيل الدخول
- المستخدم يدخل البريد الإلكتروني وكلمة المرور
- Supabase يتحقق من البيانات
- عند النجاح، إذا كان الملف موجوداً → يُوجه لتبويب الخطة
- إذا لم يكن هناك ملف → يُوجه للإعداد الأولي

#### استعادة كلمة المرور
- المستخدم يطلب بريد استعادة كلمة المرور
- Supabase يرسل رابط الاستعادة

### المرحلة 3: الإعداد الأولي (ملف اللياقة)

عملية الإعداد تجمع بيانات لياقة شاملة عبر نموذج متعدد الخطوات:

1. **المعلومات الشخصية**: العمر، الوزن (كجم)، الطول (سم)، الجنس، الوزن المستهدف
2. **هدف اللياقة**: خسارة دهون، بناء عضلات، أو لياقة عامة
3. **مستوى اللياقة**: مبتدئ، متوسط، أو متقدم
4. **إعداد التدريب**: نادي، منزل، أو معدات بسيطة
5. **مستوى النشاط**: لا شيء، خفيف، معتدل، أو عالي
6. **الجدول**: أيام التدريب المتاحة أسبوعياً
7. **مدة الجلسة**: مدة التمرين المفضلة (30-90 دقيقة)
8. **الإصابات**: أي إصابات أو قيود موجودة

البيانات تُحفظ في AsyncStorage فوراً وتتزامن مع Supabase إذا كان المستخدم مصادقاً.

### المرحلة 4: التطبيق الرئيسي

#### خطة التمارين (تبويب الخطة)

**عرض الخطة:**
- خطة تمارين أسبوعية معروضة مع جلسات لكل يوم
- كل جلسة تعرض: اسم اليوم، اسم الجلسة، المدة، عدد التمارين
- حالة الإكمال مرمزة بالألوان

**تفاصيل جلسة التمرين:**
- قائمة التمارين مع المجموعات والتكرارات وفترات الراحة
- الأوزان الموصى بها حسب الجنس ومستوى اللياقة
- روابط فيديو لعرض التمارين
- المعدات المطلوبة

**إكمال جلسة:**
1. انتقل إلى جلسة التمرين
2. حدد التمارين الفردية كمكتملة (مربع اختيار)
3. عند إكمال جميع التمارين، حدد الجلسة كمكتملة
4. الإكمال يتزامن مع Supabase (يحدث جدول `workout_sessions`)
5. يُنشأ سجل تمرين (يُخزن في `workout_logs`)

#### تخطيط التغذية (تبويب التغذية)

**تقييم التغذية:**
1. المستخدم يجيب على أسئلة حول:
   - هيكل الوجبات (وجبة + وجبات خفيفة، وجبتان، 3 وجبات، 3 وجبات + خفيفة)
   - تاريخ النظام الغذائي
   - استبيان تكرار الطعام
   - الوجبات المفضلة
2. التقييم يُحفظ محلياً

**توليد خطة التغذية:**
- الذكاء الاصطناعي يولد خطة تتضمن:
  - السعرات اليومية المستهدفة
  - توزيع الماكرو (بروتين، كربوهيدرات، دهون)
  - نمط النظام الغذائي (متوازن، عالي البروتين، إلخ)
  - توزيع الوجبات
  - توصيات

**خطط الوجبات اليومية:**
- فطور، غداء، عشاء، ووجبات خفيفة
- كل وجبة تعرض: الاسم (عربي/إنجليزي)، السعرات، الماكرو
- الوجبات مصدرها قاعدة بيانات الوجبات السعودية/الشرق أوسطية
- تتبع إكمال الوجبات

**قائمة المشتريات:**
- تُنشأ تلقائياً بناءً على خطة الوجبات
- تسرد المكونات المطلوبة للأسبوع
- يمكن تحديد العناصر كمشتراة

#### المدرب الذكي (تبويب المدرب)

- نصائح لياقة مخصصة بناءً على الملف
- اقتراحات تعديل التمارين
- نصائح تغذية
- تحليل التقدم والتوصيات

#### إدارة الملف الشخصي (تبويب الملف)

**عرض الملف:**
- عرض جميع بيانات ملف اللياقة
- تعديل معلومات الملف
- تحديث أهداف اللياقة

**تتبع التقدم:**
- إضافة إدخالات وزن مع ملاحظات اختيارية
- عرض سجل الوزن
- البيانات تتزامن مع جدول `progress_entries` في Supabase

**المفضلة:**
- حفظ التمارين المفضلة للوصول السريع
- حفظ الوجبات المفضلة للرجوع السريع
- تتزامن مع جداول `favorite_exercises` و `favorite_meals`

**المعلومات الحيوية:**
- تحليل تكوين الجسم
- حساب مؤشر كتلة الجسم
- عرض مقاييس الجسم

---

## مزامنة البيانات

### الوضع المتصل (مستخدم مصادق)
```
إجراء المستخدم → AsyncStorage (فوري) → Supabase (مزامنة خلفية)
```

### الوضع غير المتصل (ضيف أو بدون اتصال)
```
إجراء المستخدم → AsyncStorage (جميع البيانات مخزنة محلياً)
```

### المزامنة عند تسجيل الدخول
عندما يسجل المستخدم دخوله، التطبيق:
1. يجلب الملف من Supabase
2. يجلب خطط التمارين والسجلات وإدخالات التقدم
3. يجلب المفضلات
4. يدمج مع البيانات المحلية
5. يحدث واجهة المستخدم

### حل التعارضات
- البيانات البعيدة لها الأولوية للملف والخطط
- البيانات المحلية فقط (لم تتزامن بعد) تُحفظ
- أخطاء الشبكة تحفز إعادة المحاولة التلقائية مع تأخير أسي

---

## معالجة الأخطاء

| السيناريو | السلوك |
|---|---|
| خطأ شبكة أثناء الحفظ | البيانات تُحفظ محلياً، إعادة المحاولة في الفرصة التالية |
| انتهاء رمز مصادقة Supabase | تجديد تلقائي عبر عميل Supabase |
| بيانات غير صالحة من الخادم | رجوع تدريجي للتخزين المحلي |
| حقول مطلوبة مفقودة | التحقق من النموذج يمنع الإرسال |
| تسجيل حساب مكرر | رسالة خطأ مع اقتراح تسجيل الدخول |
